# Руководство по интеграции Z-уровней

Система Z-уровней в CrystallEdge саблицензирована под MIT лицензию, и это руководство призвано помочь объяснить как интегрировать эту систему в другие проекты.

## Минимальная рабочая настройка

- Скопируйте все содержимое `_CE/ZLevels` папок в `Shared`, `Server` и `Client` частях.
- Найдите в клиенте `ScalingViewport`, сделайте его partial и обновите рендеринг, по аналогии [как это сделано в CE репозитории](https://github.com/crystallpunk-14/crystall-edge/blob/e533afb11e36a512a7b32a9d326ec261f19b1c0d/Content.Client/Viewport/ScalingViewport.cs#L153-L155).
- Почините все импорты, Убедитесь что ни в одном файле нет ошибок. Для этого придется добавить некоторые дополнительные поля в ванильные прототипы и компоненты.
    - `CEPvsOverrideSystem` и `CEPvsOverrideComponent` так же саблицензированы под MIT и вы можете их себе портировать, либо заменить на стандартные `_pvs.AddGlobalOverride` и `_pvs.RemoveGlobalOverride` функции.
    - Все ассеты, такие как прототипы акшенов, шейдеры - саблицензированы под CC свободную лицензию и вы можете скопировать их себе, либо сделать свои варианты.
      - [Шейдер размытия](https://github.com/crystallpunk-14/crystall-edge/blob/master/Resources/Textures/_CE/Shaders/zblur.swsl)
      - [Прототип шейдера](https://github.com/crystallpunk-14/crystall-edge/blob/master/Resources/Prototypes/_CE/Shaders/shaders.yml#L22-L25)
      - [Прототипы акшенов для призраков](https://github.com/crystallpunk-14/crystall-edge/blob/ca1795d821637af1ba6faaf964ee598e020e1290/Resources/Prototypes/_CE/Entities/Actions/zLevels.yml)
    - `ContentTileDefinition` получил поле [Transparent](https://github.com/crystallpunk-14/crystall-edge/blob/ca1795d821637af1ba6faaf964ee598e020e1290/Content.Shared/Maps/ContentTileDefinition.cs#L134C63-L140C41), который нужно вручную проставить на true во все "прозрачные" тайлы в вашем проекте, включая стандартные тайлы космоса.
    - `CEZLevelGhostMoverComponent` необходимо добавить на [прототипы призраков](https://github.com/crystallpunk-14/crystall-edge/blob/ca1795d821637af1ba6faaf964ee598e020e1290/Resources/Prototypes/Entities/Mobs/Player/observer.yml#L31-L33) и других летающих призрачных сущностей, чтобы те могли двигаться сквозь z-уровни.
    - Необходимо отредактировать `ParallaxOverlay`, в методе `BeforeDraw()` добавив [отключение рендеринга параллакса](https://github.com/crystallpunk-14/crystall-edge/blob/e533afb11e36a512a7b32a9d326ec261f19b1c0d/Content.Client/Parallax/ParallaxOverlay.cs#L43-L48), если это не самый нижний видимый z-уровень.
    - Добавьте в свой репозиторий прототип
      <img width="336" height="139" alt="image" src="https://github.com/user-attachments/assets/23e10e94-f7d1-4c3b-99f5-d7e315d0bfe0" />
    - Необходимо добавить `CEZPhysicsComponent` на все сущности, которые по вашему мнению должны перемещаться между z-уровнями посредством гравитации.
        - Не нужно добавлять этот компонент на ВСЕ сущности, так как это сильно нагружает сервер. Стены, например, могут спокойно обойтись и без z-физики, так как никогда не откручиваются.
        - Добавляйте на `BaseItem`, мобов, откручиваемые структуры.
    - [Ключ анимации выносливости сделан публичным](https://github.com/crystallpunk-14/crystall-edge/blob/bd5aaf45e5f71bd17cbd23cfbdf923cc92d2cec4/Content.Client/Damage/Systems/StaminaSystem.cs#L18), чтобы анимация выносливости автоматически обновлялась под текущую высоту персонажа.

## Вторичные фиксы

Если выше описаны минимальные изменения, которые нужно произвести чтобы просто запустить z-уровни в вашем репозитории. То, есть еще точно много мелких изменений в коде Wizden, которые фиксят отдельные не критичные проблемы.


- `Weather Stensil Overlay` получал небольшие фиксы ([фикс 1](https://github.com/crystallpunk-14/crystall-edge/blob/bd5aaf45e5f71bd17cbd23cfbdf923cc92d2cec4/Content.Client/Overlays/StencilOverlay.Weather.cs#L46), [фикс 2](https://github.com/crystallpunk-14/crystall-edge/blob/bd5aaf45e5f71bd17cbd23cfbdf923cc92d2cec4/Content.Client/Overlays/StencilOverlay.Weather.cs#L23)), чтобы включить пустые тайлы в проверку, нужно ли рисовать погоду, учитывая что над пустыми тайлами может быть крыша.
- `LandEvent` [имеет фикс](https://github.com/crystallpunk-14/crystall-edge/blob/bd5aaf45e5f71bd17cbd23cfbdf923cc92d2cec4/Content.Shared/Throwing/ThrownItemSystem.cs#L133-L136), который убирает срабатывание ивента, если под сущностью нет пола. Отключает разбивание яиц в воздухе после броска. `LandEvent` вызывается вручную по приземлению после падения.
- Для цикла дня и ночи и цикла теней был убран случайный стартовый сдвиг, чтобы синхронизировать освещение на всех уровнях. [Тык 1](https://github.com/crystallpunk-14/crystall-edge/blob/bd5aaf45e5f71bd17cbd23cfbdf923cc92d2cec4/Content.Shared/Light/Components/LightCycleComponent.cs#L31)
- [Отключен сброс поворота камеры](https://github.com/crystallpunk-14/crystall-edge/blob/c37eebf47dc65af43fba0b73fa2fba116ab9a2d8/Content.Shared/Movement/Systems/SharedMoverController.Input.cs#L274-L283) при переходе между Z-уровнями.

## Отслеживание изменений

Для удобства отслеживания PR-ов, редактирующих и улучшающих z-уровни, вы можете отфильтровать их по zLevels метке в репозитории:

[Pull requests](https://github.com/crystallpunk-14/crystall-edge/pulls?q=is%3Apr+label%3AzLevels+is%3Aclosed)
