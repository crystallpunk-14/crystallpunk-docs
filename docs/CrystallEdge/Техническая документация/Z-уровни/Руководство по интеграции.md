# Руководство по интеграции Z-уровней

Система Z-уровней в CrystallEdge саблицензирована под MIT лицензию, и это руководство призвано помочь объяснить как интегрировать эту систему в другие проекты.

## Минимальная рабочая настройка

- Скопируйте все содержимое `_CE/ZLevels` папок в `Shared`, `Server` и `Client` частях.
- Найдите в клиенте `ScalingViewport` и обновите рендеринг, по аналогии [как это сделано в CE репозитории](https://github.com/crystallpunk-14/crystall-edge/blob/e533afb11e36a512a7b32a9d326ec261f19b1c0d/Content.Client/Viewport/ScalingViewport.cs#L153-L155).
- Почините все импорты, Убедитесь что ни в одном файле нет ошибок. Для этого придется добавить некоторые дополнительные поля в ванильные прототипы и компоненты.
    - `CEPvsOverrideSystem` и `CEPvsOverrideComponent` так же саблицензированы под MIT и вы можете их себе портировать, либо заменить на стандартные `_pvs.AddGlobalOverride` и `_pvs.RemoveGlobalOverride` функции.
    - Все ассеты, такие как прототипы акшенов, шейдеры - саблицензированы под CC свободную лицензию и вы можете скопировать их себе, либо сделать свои варианты.
    - `ContentTileDefinition` получил поле Transparent, который нужно вручную проставить на true во все "прозрачные" тайлы в вашем проекте, включая стандартные тайлы космоса.
    - `GameMapPrototype` получил поля для карт снизу и сверху над основной игровой картой. Чтобы вы могли протестировать z-уровни вам ОБЯЗАТЕЛЬНО нужно иметь прототип карты с z-уровнями, который вы запустите из лобби. 
        - Помните, что поддерживаются только планетарные карты, то есть карты с `MapComponent` и `MapGridComponent` одновременно на одной сущности. 
    - `CEZLevelGhostMoverComponent` необходимо добавить на прототипы призраков и других летающих призрачных сущностей, чтобы те могли двигаться сквозь z-уровни.
    - Необходимо отредактировать `ParallaxOverlay`, в методе `BeforeDraw()` добавив отключение рендеринга параллакса, если это не самый нижний видимый z-уровень. [Пример можете найти в репозитории](https://github.com/crystallpunk-14/crystall-edge/blob/e533afb11e36a512a7b32a9d326ec261f19b1c0d/Content.Client/Parallax/ParallaxOverlay.cs#L43-L48).
    - Добавьте в свой репозиторий прототип 
    ```yml
    - type: entity
      id: CEZLevelEye
      save: false
      categories: [ HideSpawnMenu ]
  ```
    - Необходимо добавить `CEZPhysicsComponent` на все сущности, которые по вашему мнению должны перемещаться между z-уровнями посредством гравитации.
        - Не нужно добавлять этот компонент на ВСЕ сущности, так как это сильно нагружает сервер. Стены, например, могут спокойно обойтись и без z-физики, так как никогда не откручиваются.
        - Добавляйте на `BaseItem`, мобов, откручиваемые структуры.

## Вторичные фиксы

Если выше описаны минимальные изменения, которые нужно произвести чтобы просто запустить z-уровни в вашем репозитории. То, есть еще точно много мелких изменений в коде Wizden, которые фиксят отдельные не критичные проблемы.


!!! warning "Список не полон"
    Я (Ed) точно помню не все правки которые сделал в коде Wizden, но постараюсь пополнять этот список.

- `Weather Stensil Overlay` получал небольшие фиксы, чтобы включить пустые тайлы в проверку, нужно ли рисовать погоду, учитывая что над пустыми тайлами может быть крыша.
- `LandEvent` имеет фикс, который убирает срабатывание ивента, если под сущностью нет пола. Отключает разбивание яиц в воздухе после броска. `LandEvent` вызывается вручную по приземлению после падения.
- Для цикла дня и ночи и цикла теней был убран случайный стартовый сдвиг, чтобы синхронизировать освещение на всех уровнях.

## Отслеживание изменений

Для удобства отслеживания PR-ов, редактирующих и улучшающих z-уровни, вы можете отфильтровать их по zLevels метке в репозитории:

[Pull requests](https://github.com/crystallpunk-14/crystall-edge/pulls?q=is%3Apr+label%3AzLevels+is%3Aclosed)
