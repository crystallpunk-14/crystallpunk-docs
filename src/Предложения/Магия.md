Данный документ призван описать реализацию арканической магии из DnD в реалиях RobustToolbox. Способов реализации магии можно придумать сотни вариантов, и необходимо выбрать конкретное решение, оптимальное для проекта.

# Магия как элемент сеттинга DnD

Сами магические проявления в рамках DnD представляют из себя конкретные заклинания - определенные эффекты, вроде "Волна грома". Каждое заклинание имеет свои правила применения, ограничения и эффекты. К каждому заклинанию можно получить доступ различными способами.

Всего есть **три основных способа использования магии**:

1) Арканическая магия - постижение магии путем исследований и экспериментов, а так же многолетней практики. 
2) Божественная магия - доступ к магии, полученный от высших существ или явлений.
3) Исскуственная магия ([Eberron]([url](https://eberron.fandom.com/wiki/Magic))) - Более техническая специальность, не дающая человеку пользоваться магией напрямую, но позволяющая создавать механизмы и приборы, способные вызывать эффекты заклинаний. 

Сами проявления магии в реалиях пятой редакции DnD делятся на следующие **категории**:

1) Воплощение - создают различные эффекты из магической энергии. Это могут быть вспышки огня или молний. Другие используют позитивную энергию для лечения ран.
2) Вызов - перемещают предметы и существ из одного места в другое. Некоторые призывают существ и предметы к заклинателю, другие же перемещают заклинателя в другое место. Некоторые заклинания создают предметы и эффекты из ничего.
3) Иллюзия - обманывают чувства или сознания других. Они заставляют видеть вещи, которых нет, не замечать вещи, которые есть, слышать не настоящие звуки, или вспоминать то, чего никогда не было. Некоторые иллюзии создают образ, которые видят все, но самые коварные иллюзии помещают изображение прямиком в сознание конкретного существа.
4) Некромантия - манипулируют энергиями жизни и смерти. Такие заклинания могут давать дополнительные резервы жизненных сил, забирать жизненные силы у других, создавать нежить, и даже оживлять мертвецов. Создание нежити при помощи таких заклинаний некромантии как восставший труп не является добрым поступком, и только злые персонажи используют это заклинание часто.
5) Ограждение - носят защитный характер, хотя у некоторых из них возможно агрессивное использование. Они создают магические барьеры, снимают вредоносные эффекты, причиняют вред нарушителям границ, или изгоняют существ на их родной план существования.
6) Очарование - воздействуют на чужое сознание, контролируя поведение существ или влияя на него. Такие заклинания могут заставить врагов считать заклинателя союзником, заставить существо совершить определённые действия, или даже контролировать другое существо как марионетку.
7) Преобразование - изменяют свойства существ, предметов или окружения. Они могут сделать врага безвредным существом, увеличить силу союзника, переместить предмет по приказу заклинателя, или усилить врождённые свойства существа к восстановлению, чтобы оно быстрее оправилось от ранения.
8) Прорицание - раскрывают информацию, будь то давно забытые тайны, проблески будущего, местонахождение тайников, истина, сокрытая за иллюзией, или видение далёких мест и существ.

Заклинания так же делятся на **4 вида использования**:

1) Заговоры - простейшие заклинания, не требующих ресурсов на создание
2) Заклинания от 1 до 9 уровня - большая часть эффектов, тратящая ресурсы в виде ячеек заклинаний
3) Ритуалы - альтернативное использование некоторых заклинаний 2 пункта, тратящая время и материалы.
4) Артефакты (Eberron) - использование эффектов из магических предметов. Тратит ресурсы из самого предмета, в виде элементальной энергии в драконьих осколках.

У заклинаний есть ограничения - **компоненты**. 
1) Вербальный - заклинание требует возможности мага произносить слова
2) Соматический - заклинание требует возможности мага жестикулировать
3) Материальный - заклинание требует наличие определенных предметов для воспроизведения, и может их тратить.

Некоторые заклинания требуют **концентрации** мага на них для их поддержки.

# Адаптация к проекту

В том виде в котором магия существует в DnD - она будет плохо подходить к разрабатываемому проекту:
Заклинания с четко описанным эффектом нарушает правила:
  - "Ваша механика не должна допускать идеальный решений". Четко описанные заклинания не имеют возможности облажаться при их использовании, не имплементируя механик исходящего рандома.
  - "Глубокий симуляционный процесс" - Четко описанные механики не ощущаются симуляционным процессом, а скорее игровой условностью.
  - "Механики должны стремиться быть просоциальными" - Заклинания и магия не поощряет взаимодействия между игроками в том виде в котором она реализована в DnD
  - "Избегайте меты" - Конкретные заклинания, доступные четко описанными методами, непременно создадут "мету", оптимальные билды, и возможности их предугадывать заранее.

Данный документ ставит задачу расписать магическую систему, максимально близкую к духу DnD (ради сохранения узнаваемости и привлекательности), но лишенную всех вышеописанных недочетов.

# Реализация магии в RobustToolbox

## Магические эффекты

Магический эффект - это Entity, существующие в игровом мире, как любые другие сущности. Его поведение контролируются наложенными на сущность компонентами.

У магических эффектов есть общий компонент с параметрами:
**Запас энергии (float)** - Количество магической энергии, хранящейся в заклинании. Компоненты могут тратить или восполнять энергию. Если энергия падает до 0, заклинание развеивается, сущность удаляется.
**Контекст** - настройка для заклинания. Структура хранящая параметры, которые используют компоненты магического эффекта:
- **Целевая точка (MapCoordinate)**

В игре может существовать большое количество способов появления магических эффектов.

Пример магического эффекта: Огненный шар

## Арканическая магия

Беклог до рефактора магии от Keron:
https://github.com/space-wizards/space-station-14/pull/22568

Арканическая магия - система, позволяющая игрокам создавать и запоминать арканические заклинания.

Арканичесакое заклинание - это Action-энтити, которое создает магический эффект, передавая в него ряд параметров (заполняя контекст). Использование заклинания передает магическую энергию кастера в энергозапас эффекта.

Арканическое заклинание - это энтити-Action, которое вызывает определенный магический эффект.
Заклинание имеет следующие свойства:
**Эффект** - конкретное заклинание


Заклинание может храниться записанным на носитель (свитки, книги). Могут копироваться с них на другие носители. 
Игроки могут использовать носители, чтозы запомнить заклинания, перенося их себе в разум.

Запомненные заклинания находятся в хотбаре действий игрока, и могут быть использованы в любой момент.



















Заклинание - один из способов создания магических эффектов.

Заклинания в рамках движка - это Сущности (Actions), прикрепленные:
1) К разуму (запомненные заклинания, дарованные от высших сущностей заклинания) *Беклог до момента реворка магии от Keron*
2) К сущности (Зачарованные артефакты, татуировки, книги, физические предметы)

Каждое заклинание является последовательностью из Х модулей.

Модуль - минимальная магическая структура, из которых собирается заклинание. Существуют следующие виды модулей:

### Триггер
Ситуация в игровом мире, активирующая выполнение заклинания. Чем ситуативнее триггер, тем выше мощность заклинания.

Примеры:
- Использование с хотбара (наличие триггера выводит иконку в хотбар)
- Смерть 
- Получение урона
- Падение в крит
- Произнесение ключевого слова в радиусе
- Использование предмета на котором наложено заклинание
- Таймер
- Наступление ночи

Добавление нескольких триггеров в одно заклинание добавляет больше способов активации этого заклинания. 

### Условие
Ограничения, наложенные на триггер. Если условие в момент активации не выполняется - заклинание не срабатывает. Если условие выполняется - заклинание срабатывает, при этом получая бонус в виде сниженного расхода ресурсов.

В эту категорию попадает механика компонентов из днд.
Примеры условий:
- Материальный компонент (необходимо наличие определенной сущности рядом с точкой исполнения заклинания)
- Вербальный компонент (источник заклинания должен иметь возможность разговаривать)
- Соматический компонент (у источника должны быть руки, и они должны быть свободные)
- Ночное время суток
- Отсутствие разумных в большом растоянии от заклинателя
- Получение урона ожогами в последние 10 секунд
- Жертвоприношение (рядом с источником заклинания в последние 30 секунд умерло помеченное меткой жертвы существо)
- Целевая точка находится в зоне видимости
- Целевая точка в радиусе X блоков (защита от суицида)
- Вокруг начальной точки расставлены 5 красных горящих свечей
- 2 других существа используют такой же эффект заклинания в той же целевой точке.
- Нарисованы на полу рядом конкретные символы (руны, ритуальные круги)
- т.д.

Разные условия по разному ситуативы. Чем сложнее соблюсти условие - тем дешевле воспроизвести эффект.
Несколько добавленных в заклинание условий могут накладываться друг на друга, стакая уменьшение расходов энергии.

### Начальная точка
По умолчанию все заклинания имеют начальную точку в месте источника заклинания. Модули этого типа могут сдвигать начальную точку за счет дополнительных трат ресурсов.

Примеры те же самые что у целевой точки. НО

Чем дальше исходная точка от заклинателя, тем выше стоимость заклинания. Попытка скастовать огненный шар в километре от себя может оказаться настолько ресурсоемкой, что полностью истощит заклинателя при попытке и убьет его.

Если в заклинание добалено несколько модулей с начальными точками, заклинание будет выбирать случайную начальную точку из предоставленных. Трата ресурса будет зависеть от выбранной точки.

### Целевая точка
По умолчанию все заклинания имеют целевую точку в месте источника заклинания. Модули этого типа могут сдвигать целевую точку без трат ресурсов. 

Примеры:
- Точка курсора (если имеется, расход зависит от дальности курсора)
- Вперед, Х тайлов (берется точка в сторону направления источника)
- Назад, Х тайлов
- Случайное живое существо в радиусе Х тайлов
- Случайный объект по вайтлисту в радиусе Х тайлов
- Персонаж с конкретым именем
- Конкретные координаты

Если в заклинание добавлено несколько модулей с целевыми точками, заклинание будет выбирать случайную целевую точку из предоставленных

### Модификаторы

Абстрактные модификаторы, накладываемые на заклинания. Такие как:
- Уменьшение расхода энергии и уменьшение мощности
- Увеличение расхода, увеличение мощности
- Трата здоровья, увеличение мощности
- Компонент самонаводки заклинания, сильное увеличение расхода
- Поддержание (концентрация). Расход энергии и мощность сильно снижены, на заклинание автоматически применяется каждые N секунд, пока условия не перестанут выполняться.
- **Ритуал**. Увеличивает время каста заклинания в 10 раз, снижает расходы маны на заклинание в 10 раз.
- Вложенные заклинания. Любое количество других вложенных заклинаний, готовых активироваться от действия этого заклинания. (Хз как реализовать пока)

На заклинание может быть наложено много модификаторов

### Эффект

Набор компонентов, которые наложатся на создаваемуюю сущность-заклинание.



Конкретные игровые эффекты, в виде энтити, принимающие в себя следующие параметры от всех остальных модулей:
- Начальная точка
- Конечная точка
- Мощность
- Дополнительные компоненты (если не поддерживаются заклинанием, все равно будут добавлены на сущность-эффект, но просто проигнорированы)

Эти эффекты являются отдельными энтити, и могут использовать (или не использовать) полученные параметры для реализации эффекта.
В эффекты входят уже конкретные игровые действия:
- Огненный шар
- Магический барьер
- Аура исцеления
- Спавн колючих лоз (полоса ползет из начальной в конечную точку)
- Вызов демона-охранника (спавнится в начальной, охраняет или дерется в конечной точке)

Некоторые эффекты здесь подходят под категорию заговоров - в том плане, что по умолчанию предоставляют очень слабый эффект с слабыми затратами ресурсов. Но в этой системе и их можно "усилить" другими модулями.

Именно эти эффекты разделены на категории (вызов, ограждение, воплощение...), но я пока не вижу способов использования категорий, кроме как вещей вроде баффов заклинаний определенной категории. (артефакт -50% расхода на эффекты школы вызова)

Имеет смысл вшивать в эффекты встроенные другие модули, чтобы например эффект заморозки требовал условие "материального компонента: льда". Эти встроенные в модули субмодули добавляются в общий стек заклинания. Это преследует 2 цели:
- Ограничение мощных заклинаний за конкретными требованиями
- Поощрение сциальных взаимодействий. Условия заклинаний могут и должны заставлять игроков контактировать друг с другом.

Эффект заклинания для выполнения затрачивает ману. Количество затрачиваемой маны высчитывается из всех условий и базового значения манакоста эффекта. Если маны оказывается недостаточно, заклинание получает энергию, нанося урон заклинателю или артефакту. Если этого урона хватило, чтобы увести в крит заклинателя или сломать предмет, эффект не выполняется.

## Составление заклинания

У нас есть 3 вида источника магии, и я считаю для каждого из них можно сделать свой способ составления заклинаний.

1) Арканическая магия. Изучение, поиск модулей в течении раунда, комбинация и составление заклинаний в свитки и книги. Запоминание записанных заклинаний, и использование с хотбара или как реакции (триггер на получение урона). Ограничено количеством слотов, которые может запомнить единоразово игрок, и магической энергией игрока. Запоминание новых заклинаний сверх лимита заставляет забыть самые старые.

2) Божественная магия. Игрок получает готовые рандомно-сгенерированные (или из пресетов) заклинания от высших сущностей-покровителей, и могут использовать их ограниченное количество раз. Они не понимают как составлять свои заклинания, и не могут их редактировать. Ограничено количеством заклинаний, и числом их использования.

3) Исскуственная магия. Конструирование механизмов, обеспечение магической энергией через осколки, запись в них заклинаний. Обвешивание зачарованными артефактами своей тушки, использование их в нужные ситуации. Разные механизмы ограничены конкретным количеством слотов, которые можно заполнить модулями, энергоемкостью и ценой ресурсов.

## Антимета (под вопросом)

Учитывая модульность заклинани, можно достаточно просто рандомизировать некоторые данные, предоставляя случайные стартовые условия для всех пользователей магии. Это может быть:
- Рандомно генерирующиеся изучения, предоставляющие для арканической и исскуственной магии разные наборы доступных для комбинирования модулей.
- Рандомно генерирующиеся заклинания, предоставляемые от покровителей
- Рандомно генерирующиеся зачарованные или проклятые магические предметы, которые можно находить в мире и разбирать на знания. (проклятье - заклинание, вредное для заклинателя)

Цель у этого - обеспечить невозможность предугадывать чем будут пользоваться другие игроки, и невозможность строить мета-игру на основе этих знаний.

## Примеры заклинаний из модулей

Заклинание ШАГ ИЗ ТЬМЫ
Триггер: Использование с хотбара
Начальная точка: по умолчанию, кастер
Целевая точка: курсор
Условия:
- Ночное время (меньше манакост)
- Кастер не получал урона в течении минуты (меньше манакост)
- Вербальный компонент (меньше манакост)
- Соматический компонент (меньше манакост)
Эффекты:
- Пространственный разлом (телепортирует все из начальной точки в конечную)
  Вложенные условия:
  - Целевая точка в зоне видимости
  - Начальная точка в зоне видимости

Результат: заклинание в хотбаре, позволяющее открыть короткий, на пару секунд портал в точку курсора, и телепортироваться туда самому, или закинуть в него какой-то объект.
Благодаря условиям, стоимость достаточно дорогого заклинания становится дешевой и относительно доступной.